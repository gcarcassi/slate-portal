{%extends "base.html"%}

{%block title%}
  Instance Profile
{%endblock%}

{%block body%}
<section id="app-profile" class="bg-light">
  <div class="container col-lg-11 mx-auto">

    <div class="row">
      <div class="col-lg-12 mx-auto">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{url_for('dashboard')}}">Home</a></li>
          <li class="breadcrumb-item"><a href="{{url_for('list_instances')}}">Instances</a></li>
          <li class="breadcrumb-item active">{{instance['metadata']['name']}}</li>
        </ol>

        <h1>Instance: {{instance['metadata']['name']}}</h1>
        <h4>Cluster: <span class='text-muted'>{{instance['metadata']['cluster']}}</span></h4>
        <a href="#" class="btn btn-danger btn-sm" onclick="btnConfirm()">Delete Instance</a>
        <hr/>

        <ul class="nav nav-tabs" role="tablist">
          <li class="nav-item">
            <a class="nav-link active" href="#details" role="tab" data-toggle="tab">Details</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#configuration" role="tab" data-toggle="tab">Configuration</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#logs" role="tab" data-toggle="tab">Logs</a>
          </li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
          <div role="tabpanel" class="tab-pane active" id="details">
            {% if instance_status == 'Not Error' %}
              {% if instance_detail['services'] %}
            <div class="table-responsive">
              <br>
              <h4>Detailed Services</h4>
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">External IP</th>
                    <th scope="col">Ports</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>{{instance_detail['services'][0]['name']}}</td>
                    <td>{{instance_detail['services'][0]['externalIP']}}</td>
                    <td>{{instance_detail['services'][0]['ports']}}</td>
                  </tr>
                </tbody>
              </table>
            </div>
              {% endif %}
            <br>
            <div class="table-responsive">
              <h4>Pods</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Host Name</th>
                    <th scope="col">Host IP</th>
                    <th scope="col">Status</th>
                    <th scope="col">Created</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    {% if instance_detail['details']['pods']%}
                    <td>{{instance_detail['details']['pods'][0]['hostName']}}</td>
                    <td>{{instance_detail['details']['pods'][0]['hostIP']}}</td>
                    <td>{{instance_detail['details']['pods'][0]['status']}}</td>
                    <td>{{instance_detail['details']['pods'][0]['created']}}</td>
                    {% else %}
                    <td>No pods available</td>
                    {% endif %}
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="table-responsive">
              <h4>Condition</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Type</th>
                    <th scope="col">Status</th>
                    <th scope="col">Last Transition Time</th>
                    <th scope="col">Last Probe Time</th>
                  </tr>
                </thead>
                <tbody>
                  {% if instance_detail['details']['pods']%}
                    {% for condition in instance_detail['details']['pods'][0]['conditions']%}
                  <tr>
                    <td>{{condition['type']}}</td>
                    <td>{{condition['status']}}</td>
                    <td>{{condition['lastTransitionTime']}}</td>
                    <td>{{condition['lastProbeTime']}}</td>
                  </tr>
                    {% endfor %}
                  {% else %}
                  <tr>
                    <td>N/A</td>
                  </tr>
                  {% endif%}
                </tbody>
              </table>
            </div>
            <div class="table-responsive">
              <h4>Pod Containers</h4>
              <table class="table">
                <thead>
                  <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Image</th>
                    <th scope="col">Restart Count</th>
                    <th scope="col">Started Running</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    {% if instance_detail['details']['pods']%}
                      {% if instance_detail['details']['pods'][0]['containers'] %}
                    <td>{{instance_detail['details']['pods'][0]['containers'][0]['name']}}</td>
                    <td>{{instance_detail['details']['pods'][0]['containers'][0]['image']}}</td>
                    <td>{{instance_detail['details']['pods'][0]['containers'][0]['restartCount']}}</td>
                        {% if instance_detail['details']['pods'][0]['containers'][0]['state']['running'] %}
                    <td>{{instance_detail['details']['pods'][0]['containers'][0]['state']['running']['startedAt']}}</td>
                        {% else %}
                    <td>Currently Not Running</td>
                        {% endif %}

                      {% else %}
                    <td>No Containers Currently Running</td>
                      {% endif %}
                    {% else %}
                    <td>N/A</td>
                    {% endif %}
                  </tr>
                </tbody>
              </table>
            </div>
            {% else%}
            <h1>Detailed services information currently not available</h1>
            {% endif %}
          </div>
          <!-- CONFIGURATION TAB PANEL -->
          <div role="tabpanel" class="tab-pane fade" id="configuration">
            <br>
            <!-- <h3>Configuration</h3> -->
            <pre>{% if instance_detail['metadata']['configuration'] %}{{instance_detail['metadata']['configuration']}}{% else %}Configuration currently unavailable{% endif %}</pre>
          </div>
          <!-- INSTANE LOG TAB PANEL -->
          <div role="tabpanel" class="tab-pane fade" id="logs">
            <br>
            <!-- <h3>Logs</h3> -->
            <pre class="app-logs">{% if instance_log['logs'] %}{{instance_log['logs']}}{% else %}Logs currently unavailable{% endif %}</pre>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>

<script>

function btnConfirm() {
    var r = confirm("Are you sure you want to delete this instance?");
    if(r == true){
      window.location.href = "{{url_for('delete_instance', name=name)}}";
    }
}

</script>
{%endblock%}
